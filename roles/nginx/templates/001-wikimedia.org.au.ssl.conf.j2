#
# Main domain, including default HTTP and SNI virtual host
#
server {
  listen 80 default_server;
  listen [::]:80 default_server;
  server_name {{ wmau_domain }};
  return 301 https://{{ wmau_domain }}$request_uri;
}

server {
  listen 443 ssl default_server;
  listen [::]:443 ssl default_server;

{% if not is_snakeoil %}
  ssl_certificate /etc/letsencrypt/live/{{ wmau_domain }}/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/{{ wmau_domain }}/privkey.pem;

  ssl_stapling on;
  ssl_stapling_verify on;
  ssl_dhparam /etc/ssl/dhparam.pem;
  ssl_protocols TLSv1.2 TLSv1.1 TLSv1;
  ssl_prefer_server_ciphers on;
  ssl_session_cache shared:TLS:2m;
{% else %}
  #
  # Self signed certs generated by the ssl-cert package
  # Don't use them in a production server!
  #
  include snippets/snakeoil.conf;
{% endif %}

  server_name {{ wmau_domain }};

  root /var/www/nginx;

  location /.well-known {
    alias /var/www/nginx/.well-known;
  }

  location / {
    proxy_set_header Host       {{ wmau_domain }};
    proxy_set_header X-Forwarded-For $remote_addr;
    proxy_set_header X-Forwarded-Host   {{ wmau_domain }}:443;
    proxy_set_header X-Forwarded-Server {{ wmau_domain }};
    proxy_set_header X-Forwarded-Port   443;
    proxy_set_header X-Forwarded-Proto  https;
    proxy_pass http://127.0.0.1:8080/;
  }
}
